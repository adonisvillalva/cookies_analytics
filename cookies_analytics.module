<?php
function cookies_analytics_block_info() {
    $blocks = array();
  
    // Define el bloque de popup.
    $blocks['cookies_analytics'] = array(
      'info' => t('Cookie Analytics'),
      'cache' => DRUPAL_NO_CACHE, // Evita el caché del bloque.
    );
  
    return $blocks;
  }
  
  /**
   * Implementa hook_block_view().
   */
  function cookies_analytics_block_view($delta = '') {
    $block = array();
  
    if ($delta == 'cookies_analytics') {
      // Verifica si es la primera visita del usuario mediante una cookie.
      if (!isset($_COOKIE['cookies_analytics_visited'])) {
        // Carga la librería de jQuery UI.
        drupal_add_library('system', 'ui.dialog');
  
        // Agrega el CSS y el JS para mostrar el popup de bienvenida.
        drupal_add_css(drupal_get_path('module', 'cookies_analytics') . '/css/popup.css');
        drupal_add_js(drupal_get_path('module', 'cookies_analytics') . '/js/popup.js');
  
        // Crea el contenido del popup de bienvenida.
        $popup_content =    '<div id="cookie_analytics_popup">' .
                            '<p>Este sitio utiliza cookies y Google Analytics para mejorar tu experiencia. ¿Aceptas el uso de cookies y el análisis de datos por Google Analytics?</p>' .
                            '<button id="cookie_analytics_aceptar_btn">Aceptar</button></div>';
  
        $block['content'] = $popup_content;
      }
    }
  
    return $block;
  }
  
  /**
   * Implementa hook_menu().
   */
  function cookies_analytics_menu() {
    $items = array();
  
    // Ruta para almacenar la visita del usuario mediante Ajax.
    $items['cookies-analytics/aceptar'] = array(
      'page callback' => 'cookies_analytics_aceptar',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );
  
    return $items;
  }
  
  /**
   * Callback para almacenar la visita del usuario mediante Ajax.
   */
  function cookies_analytics_visited() {
    // Establece una cookie para recordar la visita del usuario.
    setcookie('cookies_analytics_visited', 'true', time() + (365 * 24 * 60 * 60), '/');
    return '';
  }